# ODK Analyser User Guide

This document provides instructions on how to set up an instance of the ODK Analyser system. The system can copy data from an ODK Archiver folder and then perform downstream data management and report generation. R makes a good option for control software because it works cross-platform and has capacity to perform system calls where needed. ODK Analyser can be used as a standalone analysis pipeline, or can be automated using cron as explained [here](../03_crontabs/README.md).

The system is simple and requires very little setup. 


### Requirements

* An ODK Archiver project folder, from which to grab data in the form of CSV files. By default the CSV files should be in a subfolder called `Data/Output`
* A copy of R with any packages required for analysis. 
* An installationof [Pandoc](https://pandoc.org/) which helps create reports in PDF and other formats.


### Setup 

Create a folder for the project in the form of `/user/hilary/Documents/Analyser_project_01`. It makes sense to align the names of your archiver and analyser folders. 

### The ODK Analyser

The basic design uses a master R script which is called from `cron` and which performs some basic steps to handle the data and set up logs before it goes on to run other scripts using either R's `source` or `system` commands. 

You will need to make some changes to the script and a pr√©cis of how the system works is provided in the following breakdown of the code





```
con<-file("analysis.log"). 
sink(con, append=TRUE)
sink(con, append=TRUE, type="message")
```
* This section creates an analysis uses R's `sink` command to divert R output and messages to the `analysis.log` file. If using `cron` to schedule the ODK Analyser, you'll also get a log from system messages that is independant of the `analysis.log`. Look at the system log for errors relating to `cron` and the `analysis.log` for problems within your R scripts. A good practise is to add a sink like this to any subscripts that you run using the `source` command. Each script and subscript will then have a separate log, which makes bugs easier to track and fix.


```
  #set pandoc - in Rscript calls run by cron, you may need to define the correct location of pandoc. 
  Sys.setenv(RSTUDIO_PANDOC="/usr/bin/")
```
* This section tells R where to look for pandoc. If you don't know where yours is, try entering `which pandoc` on a terminal. 


``` ################################################################################################################
  #PULL FROM ARCHIVER
  ################################################################################################################
  {
  rm(list=ls())
  unlink("Output/",recursive = T)
  system("cp -rf ~/Documents/Hilary/Documents/Archiver_project_01/Data/Output  ./Output")
  unlink("report/",recursive = T)
  unlink("*.zip")
  }
```
* This section copies the contents of the ODK archiver's `Data/Output` folder. ODK Analyser never works live on the original CSV files, but instead makes a copy, leaving the originals intact. 

 ```
 ################################################################################################################
  #DEFINE THE DIRECTORIES FOR ANALYSIS
  ################################################################################################################


  {
    #directories
    export.dir.name <- paste(getwd(),"Output",sep="/")
    report.dir.name <- paste(getwd(),"report",sep="/")
  }
```
* In general you won't need to change this section, but if you do it allows you to specify where to put the raw data `export.dir.name` and reports generated by R `report.dir.name`.

```


  ################################################################################################################
  #create directories if needed
  ################################################################################################################
  {
    if(!file.exists(export.dir.name)){dir.create(export.dir.name)}
    if(!file.exists(report.dir.name)){dir.create(report.dir.name)}

  }

```
* Checks if these folders exist and if they don't creates them.


```
  ################################################################################################################
  # Run other scripts to perform main analyses
  ################################################################################################################
  source("Analysis_Script_01.R")
  source("Analysis_Script_02.Rmd")
  ################################################################################################################
```
* Here you would provide your own scripts to perform your main analysis. Scripts will be run sequentially.


```
################################################################################################################
  # Write an R object
  ################################################################################################################

  message("writing workspace")
  save.image(compress = "gzip",safe = TRUE,file = "WORKSPACE.Rdata")
```
* It is often desirable to open and work with the final R Workspace, so this last command creates an R workspace in .RData format which can be opened using the command `load("WORKSPACE.RData")`
